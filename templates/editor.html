<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor HTML Profesional</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="/static/styles.css">
    <script defer src="https://cdn.jsdelivr.net/gh/hunghg255/quill-resize-module/dist/quill-resize-image.min.js"></script>
</head>
<body class="bg-blue-50 text-blue-900">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-700">Editor HTML Profesional</h1>
        <div class="card mb-6 bg-white shadow-lg rounded-lg" role="region" aria-labelledby="editor-title">
            <div class="card-header bg-blue-700 text-white p-4 rounded-t-lg">
                <h2 id="editor-title" class="card-title text-xl">Editor</h2>
            </div>
            <div class="card-content p-4">
                <div id="editor" class="w-full h-[calc(100vh-400px)] mb-4 bg-white border border-blue-300 rounded-lg" role="textbox" aria-multiline="true"></div>
                <div class="flex justify-between">
                    <form action="/download" method="post">
                        <input type="hidden" name="content" id="html-content">
                        <input type="hidden" name="file_type" value="html">
                        <button type="submit" onclick="setHtmlContent()" class="bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800">Descargar HTML</button>
                    </form>
                    <form action="/download" method="post">
                        <input type="hidden" name="content" id="css-content">
                        <input type="hidden" name="file_type" value="css">
                        <button type="submit" onclick="setCssContent()" class="bg-blue-700 text-white px-4 py-2 rounded-lg hover:bg-blue-800">Descargar CSS</button>
                    </form>
                </div>
            </div>
        </div>
        <div class="card bg-white shadow-lg rounded-lg" role="region" aria-labelledby="css-title">
            <div class="card-header bg-blue-700 text-white p-4 rounded-t-lg">
                <h2 id="css-title" class="card-title text-xl">CSS Personalizado</h2>
            </div>
            <div class="card-content p-4">
                <textarea id="css-editor" class="w-full h-64 font-mono bg-white border border-blue-300 rounded-lg p-2" placeholder="Añade tu CSS personalizado aquí..." aria-label="CSS editor"></textarea>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cssEditor = document.getElementById('css-editor');

            var toolbarOptions = [
                ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
                ['blockquote', 'code-block'],

                [{ 'header': 1 }, { 'header': 2 }],               // custom button values
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
                [{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
                [{ 'direction': 'rtl' }],                         // text direction

                [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                [ 'link', 'image', 'video', 'formula' ],          // add's image support
                [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
                [{ 'font': [] }],
                [{ 'align': [] }],

                ['clean']                                         // remove formatting button
            ];

            // Esperar a que el script de quill-resize-image se cargue
            if (window.QuillResizeImage) {
                Quill.register("modules/resize", window.QuillResizeImage);
            } else {
                document.querySelector('script[src*="quill-resize-image"]').addEventListener('load', () => {
                    Quill.register("modules/resize", window.QuillResizeImage);
                });
            }

            const quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: toolbarOptions,
                    resize: {
                        locale: {},
                    }
                }
            });

            function setHtmlContent() {
                const htmlContent = quill.root.innerHTML;
                document.getElementById('html-content').value = encodeURIComponent(htmlContent);
            }

            function setCssContent() {
                const cssContent = cssEditor.value;
                document.getElementById('css-content').value = encodeURIComponent(cssContent);
            }

            window.setHtmlContent = setHtmlContent;
            window.setCssContent = setCssContent;

            async function uploadImage(file) {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/upload-image', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                return data.webp_base64;
            }

            // Anular la acción predeterminada del botón de imagen de Quill
            const toolbar = quill.getModule('toolbar');
            toolbar.addHandler('image', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = async () => {
                    const file = input.files[0];
                    const base64 = await uploadImage(file);
                    const range = quill.getSelection();
                    quill.insertEmbed(range.index, 'image', `data:image/webp;base64,${base64}`);
                };
                input.click();
            });
        });
    </script>
</body>
</html>